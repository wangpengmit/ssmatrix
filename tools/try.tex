\documentclass{article}

\usepackage{amsmath}

%% a marker for further formula typesetting
\newcommand{\pruneParen}[1]{#1}

\begin{document}

\begin{coq_eval}
Set Implicit Arguments.
Unset Strict Implicit.
Unset Printing Implicit Defensive.

Require Import prelude.
Import prelude.Exports.

\end{coq_eval}

\begin{coq_example}
(*!- \coqadd{\$(\d+)}{\1} *)
(*!- \coqadd{\*}{\times} *)
(*!- \coqadd{\ba\b}{\beta} *)

Section ex1.

Variable a : int.

(*! \begin{align} *)
Lemma ex1 : (($2 * a) + (a * $4)) = ($6 * a).
Proof.
  (*! \coqvar{from} &= *)
  rewrite [(a * $4)]mulrC.
  (*! \coqvar{lhs} \\ *)
  rewrite -[(($2 * a) + ($4 * a))]mulrDl.
  (*! &= \coqvar{lhs} \\ *)
  rewrite -[($2 + $4)]/$6.
  (*! &= \coqvar{to} \label{eq:\coqvar{name}} *)
  by [].
Qed.
(*! \end{align} *)

End ex1.

Section ex2.

Variables a : int.

(*! \begin{align} *)
Lemma ex2 : (((a - a) ^ $2) + (a - a)) = $0.
Proof.
  (*! \pruneParen{\coqvar{from}} &= *)
  pattern_set (a - a).
  (*! \coqvar{lhs} \\ *)
  rewrite [(a - a)]addrN.
  (*! &= \coqvar{lhs} \\ *)
  red.
  (*! &= \coqvar{lhs} \\ *)
  rewrite -[(($0 ^ $2) + $0)]/$0.
  (*! &= \coqvar{to} \label{eq:\coqvar{name}} *)
  by [].
Qed.
(*! \end{align} *)

End ex2.

\end{coq_example}

\end{document}
